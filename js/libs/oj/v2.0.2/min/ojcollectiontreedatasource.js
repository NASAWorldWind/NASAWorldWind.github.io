/**
 * Copyright (c) 2014, 2016, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";
define(["ojs/ojcore","jquery","ojs/ojdatasource-common","ojs/ojmodel"],function(a){a.we=function(a,b,d,c,e){this.HE=a;this.Fa=b;this.hN=[];this.sz=d;this.start=c<b.length?c:b.length-1;this.count=-1===e?b.length:Math.min(b.length,e)};o_("CollectionNodeSet",a.we,a);a.we.prototype.QP=function(a){this.DV(this).then(function(){a.success&&a.success()})};a.we.prototype.DV=function(a){return new Promise(function(b){function d(e){e<c?a.H6(e,{success:function(b){null!==b?a.DV(b).then(function(){d(e+1)}):d(e+
1)}}):b(void 0)}var c=a.R();d(0)})};a.we.prototype.H6=function(a,b){var d=this.Fa.at(a);if(this.sz.Tu(d).leaf)this.hN[a]=null,b.success(null);else{var c=this.sz.xz(d),d=this.sz.Tu(d).key,e=this;this.sz.hv(c,0,-1,{success:function(c){e.hN[a]=c;b.success(c)}},d)}};a.we.prototype.getParent=function(){return this.HE};a.b.g("CollectionNodeSet.prototype.getParent",{getParent:a.we.prototype.getParent});a.we.prototype.ta=function(){return this.start};a.b.g("CollectionNodeSet.prototype.getStart",{ta:a.we.prototype.ta});
a.we.prototype.R=function(){return this.count};a.b.g("CollectionNodeSet.prototype.getCount",{R:a.we.prototype.R});a.we.prototype.getData=function(a){this.KH(a);return this.Fa.at(a).attributes};a.b.g("CollectionNodeSet.prototype.getData",{getData:a.we.prototype.getData});a.we.prototype.KH=function(a){if(a<this.start||a>this.start+this.count)throw"Out of range";};a.we.prototype.getMetadata=function(a){this.KH(a);var b={};a=this.Fa.at(a);a=this.sz.Tu(a);b.key=a.key;b.leaf=a.leaf;b.depth=a.depth;return b};
a.b.g("CollectionNodeSet.prototype.getMetadata",{getMetadata:a.we.prototype.getMetadata});a.we.prototype.Qf=function(a){this.KH(a);return this.hN[a]};a.b.g("CollectionNodeSet.prototype.getChildNodeSet",{Qf:a.we.prototype.Qf});a.Ka=function(f){f=f||{};this.kz=f.root;this.Ena=f.childCollectionCallback;this.Tu=f.parseMetadata;this.Jr=null;this.Xu="none";this.Td={};a.Ka.r.constructor.call(this)};o_("CollectionTreeDataSource",a.Ka,a);a.Ka.prototype.Tu=function(a){return{key:a.idAttribute+"\x3d"+a.id}};
a.b.ga(a.Ka,a.Ap,"oj.CollectionTreeDataSource");a.Ka.prototype.Init=function(){a.Ka.r.Init.call(this)};a.b.g("CollectionTreeDataSource.prototype.Init",{Init:a.Ka.prototype.Init});a.Ka.prototype.ff=function(a){var b=this.Td[a];if(b&&0<b.length)return b.length;this.JN(a,{success:function(a){return a.length}});return-1};a.b.g("CollectionTreeDataSource.prototype.getChildCount",{ff:a.Ka.prototype.ff});a.Ka.prototype.JN=function(a,b){this.Nf(a,null,{success:function(a){b.success(a.Fa)},error:b.error})};
a.b.g("CollectionTreeDataSource.prototype.getChildCollection",{JN:a.Ka.prototype.JN});a.Ka.prototype.Nf=function(a,b,d){b=b||{};var c=b.start?b.start:0,e=b.count?b.count:-1;if(null===a)this.hv(null,c,e,d,null);else{var g=this;this.mJ(this.kz,a,0).then(function(b){if(b){b=g.xz(b.$o);try{g.hv(b,c,e,d,a)}catch(k){d&&d.error&&d.error({status:k.message})}}else d&&d.error&&d.error(a)})}};a.b.g("CollectionTreeDataSource.prototype.fetchChildren",{Nf:a.Ka.prototype.Nf});a.Ka.prototype.b7=function(a,b,d){var c=
0;d&&d.at&&(c=d.at);b=this.VB(b);a=this.ZA(this,"insert",c,b,this.UZ(null!=b&&0<b.length?b[b.length-1]:null,a));this.handleEvent("change",a)};a.Ka.prototype.c7=function(a,b,d){var c=0;d&&d.index&&(c=d.index);this.eka(a);a=this.ZA(this,"delete",c,this.VB(b),null);this.handleEvent("change",a)};a.Ka.prototype.d7=function(a){var b=this.Lda(a),d=null,c=null;b&&(d=b.index,c=this.VB(b.Fa));a=this.ZA(this,"update",d,c,this.UZ(null!=c&&0<c.length?c[c.length-1]:null,a));this.handleEvent("change",a)};a.Ka.prototype.y6=
function(a){a=this.ZA(this,"refresh",null,this.VB(a),null);this.handleEvent("refresh",a)};a.Ka.prototype.UZ=function(f,b){var d=new a.j;d.add(b);return this.KW(d,f,0,1)};a.Ka.prototype.VB=function(f){var b=[],d=null;do d=this.Lea(f),null!==d&&(d!==a.Ka.sQ&&b.unshift(d),f=this.Mda(d));while(null!=d);return b};a.Ka.sQ="%!@ROOT%#@!";a.Ka.prototype.EB=function(f){var b=f instanceof a.t?this.Tu(f).key:f;return f?b:a.Ka.sQ};a.Ka.prototype.XS=function(a){return this.Td[this.EB(a)]};a.Ka.prototype.i0=function(f,
b){b.on(a.Y.D.ADD,this.b7,this);b.on(a.Y.D.REMOVE,this.c7,this);b.on(a.Y.D.CHANGE,this.d7,this);b.on(a.Y.D.SYNC,this.y6,this);this.Td[this.EB(f)]=b};a.Ka.prototype.eka=function(a){a=this.EB(a);for(var b in this.Td)if(this.Td.hasOwnProperty(b)&&b===a){this.Td[a].off(null,null,this);delete this.Td[a];break}};a.Ka.prototype.Rha=function(a,b){for(var d=b.length,c=0;c<d;c++){var e=this.EB(b.at(c));if(a===e)return!0}return!1};a.Ka.prototype.Lda=function(a){for(var b in this.Td)if(this.Td.hasOwnProperty(b))for(var d=
this.Td[b],c=0;c<d.length;c++)if(d.at(c)===a)return{index:c,Fa:d};return null};a.Ka.prototype.Mda=function(a){for(var b in this.Td)if(this.Td.hasOwnProperty(b)){var d=this.Td[b];if(this.Rha(a,d))return d}return null};a.Ka.prototype.Lea=function(a){for(var b in this.Td)if(this.Td.hasOwnProperty(b)&&this.Td[b]===a)return b;return null};a.Ka.prototype.xz=function(a){var b=!0,d=this.XS(a);d||(b=!1,d=this.Ena(this.kz,a),null!=d&&(this.pT(d),this.i0(a,d)));return{Fa:d,eN:b}};a.Ka.prototype.ZA=function(a,
b,d,c,e){return{source:a,operation:b,index:d,parent:c,data:e}};a.Ka.prototype.hv=function(a,b,d,c,e){var g=this;null===a&&((a=this.XS(null))?a={Fa:a,eN:!0}:(a={Fa:g.kz,eN:!1},g.i0(null,this.kz)));a&&g.AV(a,function(a){c.success&&c.success(g.KW(a,e,b,d))},c.error)};a.Ka.prototype.KW=function(f,b,d,c){return new a.we(b,f,this,d,c)};a.Ka.prototype.Yka=function(a,b){var d=this;return new Promise(function(c){function e(a,b,f){a<b.length?b.at(a,{deferred:!0}).then(function(l){if(l){var m=d.Tu(l);if(f===
m.key){c(l);return}}a++;e(a,b,f)}):c(null)}e(0,a,b)})};a.Ka.prototype.mJ=function(a,b,d){var c=this;return new Promise(function(e){c.Yka(a,b).then(function(g){function h(c,g){if(c<k){var n=g.xz(a.at(c));n.Fa?g.AV(n,function(a){g.mJ(a,b,d+1).then(function(a){a?e(a):(c++,h(c,g))})},null):(c++,h(c,g))}else e(null)}if(g)e({$o:g,depth:d});else{var k=a.length;h(0,c)}})})};a.Ka.prototype.AV=function(a,b,d){a.eN?b(a.Fa):(this.Jr&&"none"!==this.Jr&&(a.Fa.kN=this.Jr,a.Fa.jP=this.Xu),0<a.Fa.length||!a.Fa.T6()?
b(a.Fa):a.Fa.fetch({success:function(a){b(a)},error:d}))};a.Ka.prototype.Eu=function(a,b){var d=this;null===a?this.hv(null,0,-1,{success:function(a){a.QP({success:function(){b.success&&b.success(a)}})}},null):this.mJ(this.kz,a,0).then(function(c){c&&(c=d.xz(c.$o),d.hv(c,0,-1,{success:function(a){a.QP({success:function(){b.success&&b.success(a)}})}},a))})};a.b.g("CollectionTreeDataSource.prototype.fetchDescendants",{Eu:a.Ka.prototype.Eu});a.Ka.prototype.sort=function(a,b){var d=a.key,c=a.direction,
e=!1;d!==this.Jr&&(this.Jr=d,e=!0);c!==this.Xu&&(this.Xu=c,e=!0);if(e){"none"===this.Xu&&(this.Td={});for(var g in this.Td)this.Td.hasOwnProperty(g)&&this.pT(this.Td[g])}b&&b.success&&b.success()};a.b.g("CollectionTreeDataSource.prototype.sort",{sort:a.Ka.prototype.sort});a.Ka.prototype.pT=function(a){a.comparator=this.Jr;a.sortDirection="ascending"===this.Xu?1:-1;a.sort()};a.Ka.prototype.Am=function(){return{key:this.Jr,direction:this.Xu}};a.b.g("CollectionTreeDataSource.prototype.getSortCriteria",
{Am:a.Ka.prototype.Am});a.Ka.prototype.move=function(){a.l.Yb()};a.b.g("CollectionTreeDataSource.prototype.move",{move:a.Ka.prototype.move});a.Ka.prototype.rd=function(){return"invalid"};a.b.g("CollectionTreeDataSource.prototype.moveOK",{rd:a.Ka.prototype.rd});a.Ka.prototype.getCapability=function(a){return"sort"===a?"default":"move"===a?"none":"batchFetch"===a||"fetchDescendants"===a?"disable":null};a.b.g("CollectionTreeDataSource.prototype.getCapability",{getCapability:a.Ka.prototype.getCapability})});